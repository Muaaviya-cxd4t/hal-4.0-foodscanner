<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>

    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(black, rgb(60, 0, 49));
      }

      .container {
        width: 95%;
        max-width: 420px;
        background-color: #eed4f3;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }

      /* This ensures the scanner square and green lines are visible */
      #reader {
        width: 100%;
        border: none !important;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }

      #reader __dashboard {
        padding: 10px !important;
      }

      .status-box {
        min-height: 60px;
        margin: 15px 0;
        padding: 12px;
        border-radius: 8px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .idle {
        background: #f3f4f6;
        color: #4b5563;
      }
      .success {
        background: #10b981;
        color: white;
        border: 2px solid #059669;
      }
      .error {
        background: #ef4444;
        color: white;
        border: 2px solid #b91c1c;
      }

      .nav-links {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        color: white;
      }
      .btn-stats {
        background: #4a1d46;
      }
      .btn-logout {
        background: #1f2937;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 style="font-size: 20px; margin-bottom: 5px">QR Scanner</h1>
      <p style="font-size: 13px; margin-bottom: 15px">
        Aim at the Participant QR Code
      </p>

      <div id="reader"></div>

      <div id="status-display" class="status-box idle">Waiting for scan...</div>

      <div class="nav-links">
        <a href="/admin/view-stats" class="btn btn-stats">ðŸ“ˆ View Meal Stats</a>
        <a href="/logout" class="btn btn-logout">Logout</a>
      </div>
    </div>

    <script>
      const statusDisplay = document.getElementById("status-display");
      let isProcessing = false;

      function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;

        statusDisplay.textContent = "Checking Database...";
        statusDisplay.className = "status-box idle";

        fetch("/scan_qr", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `id=${encodeURIComponent(decodedText)}`,
        })
          .then((res) =>
            res.text().then((text) => ({ status: res.status, msg: text })),
          )
          .then((result) => {
            if (result.status === 200) {
              statusDisplay.textContent = "âœ… " + result.msg;
              statusDisplay.className = "status-box success";
            } else {
              statusDisplay.textContent = "âŒ " + result.msg;
              statusDisplay.className = "status-box error";
            }

            // Reset scanner for next person after 3 seconds
            setTimeout(() => {
              isProcessing = false;
              statusDisplay.textContent = "Waiting for scan...";
              statusDisplay.className = "status-box idle";
            }, 3000);
          })
          .catch((err) => {
            isProcessing = false;
            statusDisplay.textContent = "Connection Error";
            statusDisplay.className = "status-box error";
          });
      }

      // Re-initialize with UI elements enabled
      const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        showTorchButtonIfSupported: true,
        showZoomSliderIfSupported: true,
      });

      html5QrcodeScanner.render(onScanSuccess);
    </script>
  </body>
</html>
